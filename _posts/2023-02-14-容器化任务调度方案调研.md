---
layout:     post
title:      容器化任务调度crontab方案调研
subtitle:   容器化 任务调度 crontab
date:       2023-02-14
author:     kang
header-img: img/post-bg-debug.png
catalog: true
tags:
- 容器化
- docker
- 任务调度
- crontab
---

# 简介

某些业务需要周期性的定时任务，如：
- 周期性的数据分析服务；
- 周期性的资源回收服务；
- 周期性的 push 服务；
  在容器化平台部署场景下，此类定时任务面临着不同的挑战。
1. 定时任务是否具备幂等性
2. 定时任务是否要求高实时性
3. 系统是否对定时任务的执行有极高的可靠性
4. 系统是否可以追踪定时任务执行的状态

# 方案
## 方案1：业务服务自己触发
各个服务自己管理，例如使用cron库来管理定时任务
**优点**：
- 操作简单，方便管理
- 开发者只需要关心自己的任务

**缺点**：
- 容易出错
- 多容器部署，需要自己处理竞争关系
- 整个业务定时任务分散，不容易定位占用资源的任务

## 方案2：使用 Kubernetes 的 CronJob
**优点**：
- 直接利用 k8s 原生功能，方便管理和状态监控；
- 使用方便简单；
- 按需分配运行资源，Pod 的调度和容灾全交给 k8s；

**缺点**：
- 无法保证每个任务执行的可靠性，可能重复执行或者不执行；
- 每次任务的更改需要麻烦运维人员
- 上手有难度，对不熟悉k8s的同学不友好
- 依赖k8s平台，不符合服务灵活的私有化部署目标

## 方案3：第三方任务调度中心

### xxl-job
> 参考：https://marksuper.xyz/2022/10/13/xxl-job/
- 基于Java开发、分布式任务调度平台、开源、受众广、自带web界面、支持通知
- 使用http方式触发go任务
- 各个go服务需要内嵌一个http服务，并且实现各个接口的逻辑

### gocron
> https://github.com/ouqiang/gocron
- Web界面管理定时任务
- 任务执行失败可重试
- 任务执行超时, 强制结束
- 任务依赖配置, A任务完成后再执行B任务
- 使用http方式触发go任务
- 任务执行结果通知

### temporal
> https://github.com/temporalio/temporal
> https://juejin.cn/post/7009164386648457229
- golang开发、开源、使用广泛、Web界面
- 分为服务节点、工作节点
- 业务服务通过提供的sdk注册为工作节点，服务节点通过grpc的方式触发工作节点
- 有学习成本

### 自己开发
在bff层，使用cron库管理定时任务，通过grpc触发各个业务服务的任务，多容器间通过redis保证只有一个运行。


### Wait for your supplement
.........